<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vault DApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-size: 1rem;
    }
    .container {
      max-width: 600px;
      padding: 0 1rem;
    }
    .btn {
      font-size: 1rem;
      padding: 0.6rem 1rem;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }
    #status, #error {
      font-size: 0.95rem;
    }
    @media (max-width: 576px) {
      .btn {
        width: 100%;
        font-size: 0.95rem;
        padding: 0.5rem;
      }
      .input-group input {
        font-size: 0.95rem;
      }
      .card h5 {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2 class="mb-4 text-center fw-bold">Vault DApp</h2>

    <!-- Wallet Connection -->
    <div class="card p-3 mb-4 text-center">
      <button id="connectWallet" class="btn btn-primary mb-2">连接钱包</button>
      <p id="account" class="small mb-0"></p>
    </div>

    <!-- Withdraw ETH -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">提现 ETH</h5>
      <button id="withdrawETH" class="btn btn-success w-100">提取 ETH</button>
    </div>

    <!-- Withdraw Token -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">提现 ERC20 代币</h5>
      <div class="input-group">
        <input type="text" id="tokenAddress" class="form-control" placeholder="ERC20 代币地址"
          value="0x779877A7B0D9E8603169DdbD7836e478b4624789">
        <button id="withdrawToken" class="btn btn-info">提取</button>
      </div>
    </div>

    <!-- Get Unlock Time -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">锁仓信息</h5>
      <button id="getUnlockTime" class="btn btn-warning w-100 mb-2">获取解锁时间</button>
      <p id="unlockTime" class="text-center text-muted"></p>
    </div>

    <!-- Status Messages -->
    <div class="card p-3 text-center">
      <div id="status" class="text-success fw-bold"></div>
      <div id="error" class="text-danger fw-bold"></div>
    </div>
  </div>

  <script>
const useLocal = true; // true 使用 Ganache/本地节点，false 使用 MetaMask 网络
const vaultAddress = "0xc02F4F161b4B22Ce213d94513E65Fc0baf685A43"; // 合约地址
let vaultAbi;
let provider;
let signer;

const status = document.getElementById("status");
const error = document.getElementById("error");
const accountDiv = document.getElementById("account");
const unlockTimeDiv = document.getElementById("unlockTime");

// 异步加载 ABI JSON
async function loadAbi() {
  try {
    const response = await fetch("./artifacts/contracts/Valut.sol/Vault.json");
    const resJSON = await response.json();
    vaultAbi = resJSON.abi;
  } catch (err) {
    console.error("加载 ABI 失败:", err);
    error.innerText = "加载 ABI 失败，请检查 Vault.json 路径";
  }
}

// 连接钱包
async function connectWallet() {
  try {
    if (!window.ethereum && !useLocal) throw new Error("请安装 MetaMask");

    provider = useLocal
      ? new ethers.JsonRpcProvider("http://127.0.0.1:8545")
      : new ethers.BrowserProvider(window.ethereum);

    if (!useLocal) await window.ethereum.request({ method: "eth_requestAccounts" });

    signer = await provider.getSigner();
    const account = await signer.getAddress();
    accountDiv.innerText = "已连接账户: " + account;
    status.innerText = "钱包已连接";
    error.innerText = "";

    // 监听账户切换
    if (!useLocal && window.ethereum) {
      window.ethereum.on("accountsChanged", async (accounts) => {
        try {
          if (accounts.length === 0) {
            accountDiv.innerText = "未连接账户";
            status.innerText = "";
          } else {
            signer = await provider.getSigner();
            const newAccount = await signer.getAddress();
            accountDiv.innerText = "已连接账户: " + newAccount;
            status.innerText = "账户已更新";
          }
        } catch (err) {
          console.error("账户切换错误:", err);
          error.innerText = JSON.stringify(err, null, 2);
        }
      });
    }
  } catch (err) {
    console.error("连接钱包错误:", err);
    error.innerText = JSON.stringify(err, null, 2);
    status.innerText = "";
  }
}

// 使用原生 RPC 调用交易，避免 ethers.js estimateGas 封装
async function sendTransactionRaw(txData) {
  try {
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    const txHash = await window.ethereum.request({
      method: "eth_sendTransaction",
      params: [{
        from: accounts[0],
        to: vaultAddress,
        value: "0x0",
        data: txData
      }]
    });
    status.innerText = "交易发送成功: " + txHash;
    error.innerText = "";
  } catch (err) {
    console.error("MetaMask 原生 RPC 错误:", err);
    error.innerText = JSON.stringify(err, null, 2);
    status.innerText = "";
  }
}

// 提现 ETH
async function withdrawETH() {
  if (useLocal) {
    try {
      const vaultContract = new ethers.Contract(vaultAddress, vaultAbi, signer);
      const tx = await vaultContract.withdrawETH();
      status.innerText = "交易发送中: " + tx.hash;
      await tx.wait();
      status.innerText = "ETH 提现成功";
      error.innerText = "";
    } catch (err) {
      console.error("本地节点交易错误:", err);
      error.innerText = err.message || JSON.stringify(err);
      status.innerText = "";
    }
  } else {
    // withdrawETH 函数的 selector: keccak256("withdrawETH()") 前 4 字节
    const txData = "0xe086e5ec";
    await sendTransactionRaw(txData);
  }
}

// 提现 Token
async function withdrawToken() {
  const tokenAddress = document.getElementById("tokenAddress").value;
  if (!ethers.isAddress(tokenAddress)) {
    error.innerText = "请输入有效的代币地址";
    return;
  }

  if (useLocal) {
    try {
      const vaultContract = new ethers.Contract(vaultAddress, vaultAbi, signer);
      const tx = await vaultContract.withdrawToken(tokenAddress);
      status.innerText = "交易发送中: " + tx.hash;
      await tx.wait();
      status.innerText = "代币提现成功";
      error.innerText = "";
    } catch (err) {
      console.error("本地节点交易错误:", err);
      error.innerText = err.message || JSON.stringify(err);
      status.innerText = "";
    }
  } else {
    // withdrawToken(address) 函数 selector + 参数编码
    const iface = new ethers.Interface(vaultAbi);
    const txData = iface.encodeFunctionData("withdrawToken", [tokenAddress]);
    await sendTransactionRaw(txData);
  }
}

// 获取解锁时间
async function getUnlockTime() {
  try {
    const vaultContract = new ethers.Contract(vaultAddress, vaultAbi, signer);
    const unlockTime = await vaultContract.getUnlockTime();
    const date = new Date(Number(unlockTime) * 1000);
    unlockTimeDiv.innerText = "解锁时间: " + date.toLocaleString();
    status.innerText = "解锁时间已获取";
    error.innerText = "";
  } catch (err) {
    console.error("获取解锁时间错误:", err);
    error.innerText = err.message || JSON.stringify(err);
    status.innerText = "";
  }
}

// 事件绑定
document.getElementById("connectWallet").onclick = connectWallet;
document.getElementById("withdrawETH").onclick = withdrawETH;
document.getElementById("withdrawToken").onclick = withdrawToken;
document.getElementById("getUnlockTime").onclick = getUnlockTime;

// 页面加载时先加载 ABI
loadAbi();
</script>

</body>
</html>
