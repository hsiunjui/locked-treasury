<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vault DApp</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="container my-5">
    <h1 class="mb-4 text-center">Vault DApp</h1>

    <!-- Wallet Connection -->
    <div class="mb-4 text-center">
      <button id="connectWallet" class="btn btn-primary btn-lg">连接钱包</button>
      <p class="mt-2" id="account"></p>
    </div>

    <hr>

    <!-- Actions -->
    <div class="mb-4 d-flex flex-column align-items-center gap-3">
      <button id="extendLock" class="btn btn-warning btn-lg w-50">延长锁定时间</button>
      <button id="withdrawETH" class="btn btn-success btn-lg w-50">提现 ETH</button>
    </div>

    <hr>

    <!-- Withdraw Token -->
    <div class="mb-4 d-flex flex-column align-items-center gap-3">
      <div class="input-group w-50">
        <input type="text" id="tokenAddress" class="form-control" placeholder="ERC20 代币合约地址" value="0x779877A7B0D9E8603169DdbD7836e478b4624789">
        <button id="withdrawToken" class="btn btn-info">提取代币</button>
      </div>
    </div>

    <!-- Status Messages -->
    <div class="text-center">
      <div id="status" class="text-success fw-bold"></div>
      <div id="error" class="text-danger fw-bold"></div>
    </div>
  </div>

  <script>
    const vaultAddress = "0x141E6F7c5dc13FbCA0907dC45882d8b01CC5D995" // 0x474dd5f874eBE39b3aB122C1c71b17f4A8C2D190"; // 替换为你的 Vault 地址
    let vaultAbi;
    let provider;
    let signer;
    let vaultContract;

    const status = document.getElementById("status");
    const error = document.getElementById("error");
    const accountDiv = document.getElementById("account");

    // 异步加载 ABI JSON
    async function loadAbi() {
      try {
        const response = await fetch("./artifacts/contracts/Valut.sol/Vault.json");
        const resJSON = await response.json();
        vaultAbi = resJSON.abi;
      } catch (err) {
        console.error("加载 ABI 失败:", err);
        error.innerText = "加载 ABI 失败，请检查 vaultAbi.json";
      }
    }

    async function connectWallet() {
      try {
        if (!window.ethereum) throw new Error("请安装 MetaMask");
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const account = await signer.getAddress();
        accountDiv.innerText = "已连接账户: " + account;

        vaultContract = new ethers.Contract(vaultAddress, vaultAbi, signer);
        status.innerText = "钱包已连接";
        error.innerText = "";
      } catch (err) {
        error.innerText = err.message;
        status.innerText = "";
      }
    }

    async function extendLock() {
      try {
        const tx = await vaultContract.extendLock();
        status.innerText = "交易发送中: " + tx.hash;
        await tx.wait();
        status.innerText = "延长锁定时间成功";
        error.innerText = "";
      } catch (err) {
        error.innerText = err.message;
        status.innerText = "";
      }
    }

    async function withdrawETH() {
      try {
        const tx = await vaultContract.withdrawETH();
        status.innerText = "交易发送中: " + tx.hash;
        await tx.wait();
        status.innerText = "ETH 提现成功";
        error.innerText = "";
      } catch (err) {
        error.innerText = err.message;
        status.innerText = "";
      }
    }

    async function withdrawToken() {
      try {
        const tokenAddress = document.getElementById("tokenAddress").value;
        if (!ethers.isAddress(tokenAddress)) throw new Error("请输入有效的代币地址");

        const tx = await vaultContract.withdrawToken(tokenAddress);
        status.innerText = "交易发送中: " + tx.hash;
        await tx.wait();
        status.innerText = "代币提现成功";
        error.innerText = "";
      } catch (err) {
        error.innerText = err.message;
        status.innerText = "";
      }
    }

    // 事件绑定
    document.getElementById("connectWallet").onclick = connectWallet;
    document.getElementById("extendLock").onclick = extendLock;
    document.getElementById("withdrawETH").onclick = withdrawETH;
    document.getElementById("withdrawToken").onclick = withdrawToken;

    // 页面加载时先加载 ABI
    loadAbi();
  </script>
</body>
</html>
